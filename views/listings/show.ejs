<% layout("layouts/boilerplate.ejs") -%>

<%
  const catIcons = {
    "mountains": "ðŸ”",
    "trending": "ðŸ”¥",
    "tropical": "ðŸŒ´",
    "beachfront": "ðŸ–",
    "islands": "ðŸ",
    "desert": "ðŸœ",
    "arctic": "â„ï¸",
    "farms": "ðŸŒ¾",
    "camping": "â›ºï¸",
    "amazing pools": "ðŸŠ",
    "lakefront": "ðŸž",
    "luxury": "ðŸ’Ž",
    "castles": "ðŸ°",
    "entire homes": "ðŸ ",
    "iconic cities": "ðŸŒ†"
  };
%>

<section class="page page-show">
  <article class="show-card">
    <!-- Header -->
    <header class="show-header">
      <div class="show-header-bar"></div>
      <div class="show-header-text">
        <h1><%= listing.title %></h1>
        <p class="show-owner">Owned by <span><%= listing.owner.username %></span></p>
      </div>
    </header>

    <!-- Image -->
    <div class="show-image-wrapper">
      <img
        src="<%= listing.image.url %>"
        alt="<%= listing.title %>"
        class="show-image"
      />
    </div>

    <!-- Content -->
    <div class="show-body">
      <!-- Categories -->
      <% if (listing.categories && listing.categories.length > 0) { %>
      <div class="show-tags">
        <% listing.categories.forEach(function(cat) { %>
        <a
          href="/listings?category=<%= encodeURIComponent(cat) %>"
          class="tag-pill"
        >
          <%= catIcons[cat] || "ðŸ·" %> <%= cat %>
        </a>
        <% }) %>
      </div>
      <% } %>

      <!-- Description -->
      <p class="show-description"><%= listing.description %></p>

      <!-- Price + Location -->
      <div class="show-price-location">
        <div class="show-price">
          <span class="price-number">
            â‚¹<%= listing.price.toLocaleString('en-IN') %>
          </span>
          <span class="price-per">/ night</span>
        </div>
        <div class="show-location">
          <i class="bi bi-geo-alt-fill"></i>
          <span><%= listing.location %>, <%= listing.country %></span>
        </div>
      </div>

      <!-- Owner controls -->
      <% if (currUser && currUser._id.equals(listing.owner._id)) { %>
      <div class="show-owner-actions">
        <a
          href="/listings/<%= listing._id %>/edit"
          class="btn-primary btn-inline"
        >
          <i class="bi bi-pencil-square"></i>
          <span>Edit</span>
        </a>

        <form
          action="/listings/<%= listing._id %>?_method=DELETE"
          method="POST"
        >
          <button type="submit" class="btn-outline">
            <i class="bi bi-trash"></i>
            <span>Delete</span>
          </button>
        </form>
      </div>
      <% } %>

      <hr class="show-divider" />

      <!-- Review form -->
      <section class="show-reviews">
        <% if (currUser) { %>
        <form
          action="/listings/<%= listing._id %>/reviews"
          method="POST"
          novalidate
          class="form-vertical review-form"
        >
          <h2>Leave a review</h2>

          <div class="form-field">
            <label class="form-label" for="rating">Rating</label>
            <fieldset class="starability-slot">
              <input
                type="radio"
                id="no-rate"
                name="review[rating]"
                value="1"
                checked
              />

              <input
                type="radio"
                id="first-rate1"
                name="review[rating]"
                value="1"
              />
              <label for="first-rate1">1 star</label>

              <input
                type="radio"
                id="first-rate2"
                name="review[rating]"
                value="2"
              />
              <label for="first-rate2">2 stars</label>

              <input
                type="radio"
                id="first-rate3"
                name="review[rating]"
                value="3"
              />
              <label for="first-rate3">3 stars</label>

              <input
                type="radio"
                id="first-rate4"
                name="review[rating]"
                value="4"
              />
              <label for="first-rate4">4 stars</label>

              <input
                type="radio"
                id="first-rate5"
                name="review[rating]"
                value="5"
              />
              <label for="first-rate5">5 stars</label>
            </fieldset>
          </div>

          <div class="form-field">
            <label class="form-label" for="comment">Comments</label>
            <textarea
              id="comment"
              name="review[comment]"
              rows="4"
              required
            ></textarea>
          </div>

          <div class="form-actions center">
            <button class="btn-primary" type="submit">Submit</button>
          </div>
        </form>

        <hr class="show-divider" />
        <% } %>

        <!-- All reviews -->
        <% if (listing.reviews.length > 0) { %>
        <div class="reviews-list">
          <p class="reviews-title">All reviews</p>

          <% for (review of listing.reviews) { %>
          <article class="review-card">
            <div class="review-header">
              <span class="review-author">@<%= review.author.username %></span>
            </div>
            <p class="review-text"><%= review.comment %></p>
            <p
              class="starability-result"
              data-rating="<%= review.rating %>"
            ></p>

            <% if (currUser && currUser._id.equals(review.author._id)) { %>
            <form
              method="POST"
              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              class="review-delete-form"
            >
              <button class="btn-link-danger" type="submit">Delete</button>
            </form>
            <% } %>
          </article>
          <% } %>
        </div>
        <% } %>
      </section>

      <!-- Map -->
      <section class="show-map-section">
        <h3>Location on map</h3>
        <div id="map"></div>

        <div class="map-actions">
          <a
            href="https://www.google.com/maps/search/?api=1&query=<%= encodeURIComponent(listing.title + ', ' + listing.location + ', ' + listing.country) %>"
            target="_blank"
            class="btn-primary btn-inline"
          >
            Open in Maps
          </a>
        </div>
      </section>
    </div>
  </article>
</section>

<script>
  const address = "<%= listing.location %>, <%= listing.country %>";

  fetch(
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
      address
    )}`
  )
    .then((res) => res.json())
    .then((data) => {
      if (data && data.length > 0) {
        const lat = data[0].lat;
        const lon = data[0].lon;

        const map = L.map("map").setView([lat, lon], 15);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        L.marker([lat, lon])
          .addTo(map)
          .bindPopup("<b><%= listing.title %></b>")
          .openPopup();
      } else {
        console.error("Location not found:", address);
      }
    });
</script>
